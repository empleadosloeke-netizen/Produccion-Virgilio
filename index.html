<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reporte Empleados</title>

<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 12px; }
.hidden { display: none; }

button {
  width: 100%;
  padding: 16px;
  font-size: 22px;
  margin-top: 14px;
  border-radius: 6px;
}

.primary-btn { background: #1e6bd6; color: white; border: none; }

/* ---------- PANTALLA LEGAJO ---------- */
#legajoScreen h1 { font-size: 36px; text-align: center; }
#legajoInput { width: 100%; font-size: 34px; padding: 12px; text-align: center; border: 6px solid; }

/* üëá espacio donde se ver√° el historial (ACHICADO) */
#legajoHistorySpace{
  margin-top: 12px;
  min-height: 25vh;
  border-radius: 10px;
  padding: 12px;
  box-sizing: border-box;
}

/* Estilo del historial */
.history-title{
  font-size: 18px;
  font-weight: bold;
  text-align: center;
  margin-bottom: 10px;
}
.history-item{
  border: 2px solid #333;
  border-radius: 10px;
  padding: 10px 12px;
  margin-bottom: 10px;
}
.history-item .line1{
  font-size: 18px;
  font-weight: bold;
}
.history-item .line2{
  margin-top: 4px;
  font-size: 14px;
  color: #333;
  word-break: break-word;
}
.history-empty{
  font-size: 16px;
  text-align: center;
  color: #666;
  margin-top: 18px;
}

.row { display: grid; gap: 8px; margin-top: 13px; }
.row-6 { grid-template-columns: repeat(6, 1fr); }
.row-5 { grid-template-columns: repeat(5, 1fr); }
.row-4 { grid-template-columns: repeat(4, 1fr); }

.box { border: 2px solid #333; padding: 8px 4px; text-align: center; cursor: pointer; }
.box-title { font-size: 18px; font-weight: bold; }
.box-desc { font-size: 10px; margin-top: 3px; }

.top-bar { display: flex; align-items: center; margin-bottom: 6px; }
.back-top { font-size: 28px; cursor: pointer; }

.selected-container { display: flex; align-items: center; justify-content: center; margin-top: 16px; }
.back-arrow { font-size: 32px; cursor: pointer; margin-right: 10px; }
.selected-box { border: 2px solid #333; padding: 10px 22px; font-size: 28px; font-weight: bold; color: #1e6bd6; }
.selected-desc { margin-left: 12px; font-size: 18px; font-weight: bold; }

.label { margin-top: 14px; font-size: 22px; text-align: center; white-space: pre-line; }
.text-input { width: 100%; height: 68px; font-size: 64px ; border:6px solid ; text-align: center; margin-top: 8px; text-transform: uppercase; }
.text-input::placeholder { font-size: 26px; color: #aaa; }

.error { color: red; margin-top: 10px; font-size: 18px; text-align: center; }
.small { font-size: 14px; color: #666; text-align:center; margin-top:6px; }
.aviso-label{
 margin-top:10px;
 padding:8px 12px;
 background:#fff3cd;
 border:1px solid #ffeeba;
 border-radius:6px;
 font-size:30px;
 text-align:center;
}

/* ‚úÖ deshabilitado visual */
.box.disabled{
  background:#ddd;
  color:#888;
  border-color:#aaa;
  pointer-events:none;
  opacity:0.6;
}
</style>
</head>

<body>

<!-- ================= LEGAJO ================= -->
<div id="legajoScreen">
  <h1>Ingres√° tu n√∫mero de legajo</h1>
  <input id="legajoInput" type="number" inputmode="numeric">

  <!-- üëá espacio para historial -->
  <div id="legajoHistorySpace">
    <div class="history-title">√öltimos 2 reportes de este legajo</div>
    <div id="legajoHistoryContent" class="history-empty">Ingres√° tu legajo para ver el historial</div>
  </div>

  <button class="primary-btn" onclick="goToOptions()">Continuar</button>
  <div class="small" id="status"></div>
  <div id="legajoError" class="error"></div>
</div>

<!-- ================= OPCIONES ================= -->
<div id="optionsScreen" class="hidden">

  <div class="top-bar">
    <div class="back-top" onclick="backToLegajo()">‚Üê</div>
  </div>

  <div class="row row-6" id="row1"></div>
  <div class="row row-5" id="row2"></div>
  <div class="row row-5" id="row3"></div>
  <div id="pendingSuggestion"></div>

  <div id="selectedArea" class="hidden">

    <div class="selected-container">
      <div class="back-arrow" onclick="resetSelection()">‚Üê</div>
      <div id="selectedBox" class="selected-box"></div>
      <div id="selectedDesc" class="selected-desc"></div>
    </div>
    <div id="aviso" class="hidden aviso-label"></div>
    <div id="inputArea" class="hidden">
      <div id="inputLabel" class="label"></div>
      <input id="textInput" class="text-input">
    </div>

    <button class="primary-btn" onclick="send()">Enviar</button>
    <div id="error" class="error"></div>

  </div>
</div>

<script>
const GOOGLE_SCRIPT_URL =
"https://script.google.com/macros/s/AKfycbwtBRC-bEeVkFNa8MQnJwJr_L4DalBVoS6N8H9C1Z0vh2CLI29Sep7ZZIIVKz6eOGzj/exec";

const filas = {
  row1: ["EP","TP","AP","TAP","CR","CC"],
  row2: ["RT","MG","RI","EI","CT"],
  row3: ["AT","PB","Limp","Perm","PC"]
};

const desc = {
  EP:"Empec√© Picking", TP:"Fin Picking", AP:"Empec√© Armado Pedido",
  TAP:"Termin√© Armado Pedido", CR:"Control Remitos", CC:"Inicio/Fin Carga Cami√≥n",
  RT:"Recepci√≥n Mercader√≠a", MG:"Guardado a G√≥ndola",
  RI:"Recepci√≥n Insumos", EI:"Entrega Insumos",
  AT:"Atend√≠ Timbre", PB:"Par√© Ba√±o", Limp:"Limpieza",
  Perm:"Permiso de Salida", PC:"Par√© Comida",CT:"Conteo"
};

let selected = null;

/* =========================================================
   STORAGE LOCAL (reemplaza cookies)
   ========================================================= */
const HISTORY_KEY  = "legajo_history_virgilio_v1";
const STATE_KEY    = "legajo_state_virgilio_v1";

/* =========================================================
   HISTORIAL (√∫ltimos 2)
   ========================================================= */
function readHistoryMap() {
  try { return JSON.parse(localStorage.getItem(HISTORY_KEY)) || {}; }
  catch { return {}; }
}
function writeHistoryMap(map) {
  localStorage.setItem(HISTORY_KEY, JSON.stringify(map));
}
function formatDateTime(ts) {
  try { return new Date(ts).toLocaleString("es-AR"); }
  catch { return ""; }
}
function pushHistoryForLegajo(legajo, item) {
  const map = readHistoryMap();
  if (!map[legajo]) map[legajo] = [];
  map[legajo].unshift(item);
  map[legajo] = map[legajo].slice(0,2);
  writeHistoryMap(map);
}
function getHistoryForLegajo(legajo) {
  const map = readHistoryMap();
  const arr = map[legajo];
  return Array.isArray(arr) ? arr : [];
}
function renderLegajoHistory(legajo) {
  const container = document.getElementById("legajoHistoryContent");
  if (!legajo) {
    container.className = "history-empty";
    container.innerText = "Ingres√° tu legajo para ver el historial";
    return;
  }

  const hist = getHistoryForLegajo(String(legajo));
  if (!hist.length) {
    container.className = "history-empty";
    container.innerText = "No hay reportes guardados para este legajo en este dispositivo.";
    return;
  }

  container.className = "";
  container.innerHTML = hist.map(h => `
    <div class="history-item">
      <div class="line1">${h.opcion} ‚Äî ${h.descripcion}</div>
      <div class="line2">
        ${h.texto ? `Dato: <b>${h.texto}</b><br>` : ""}
        ${h.ts ? `Fecha: ${formatDateTime(h.ts)}` : ""}
      </div>
    </div>
  `).join("");
}

/* Live render historial al tipear legajo */
let legajoTimer = null;
legajoInput.addEventListener("input", () => {
  clearTimeout(legajoTimer);
  legajoTimer = setTimeout(() => {
    renderLegajoHistory(legajoInput.value);
    updateCoreButtonsState();
    renderPendingSuggestion();
  }, 150);
});

/* =========================================================
   ESTADO por legajo:
   - picking: { active, value }  (EP->TP)
   - armado:  { active, value }  (AP->TAP)
   - toggles: { CR:true, AT:true, ... } (1ra vez inicia, 2da termina)
   ========================================================= */
const CORE_CODES   = ["EP","TP","AP","TAP"];
const TOGGLE_CODES = ["CR","CC","RT","MG","RI","EI","AT","PB","Limp","PC","Perm","CT"];

function readStateMap(){
  try { return JSON.parse(localStorage.getItem(STATE_KEY)) || {}; }
  catch { return {}; }
}
function writeStateMap(map){
  localStorage.setItem(STATE_KEY, JSON.stringify(map));
}
function getLegajoState(legajo){
  const map = readStateMap();
  const key = String(legajo || "");
  if (!map[key]) {
    map[key] = { picking: {active:false,value:""}, armado:{active:false,value:""}, toggles:{} };
    writeStateMap(map);
  } else {
    map[key].picking = map[key].picking || {active:false,value:""};
    map[key].armado  = map[key].armado  || {active:false,value:""};
    map[key].toggles = map[key].toggles || {};
  }
  return map[key];
}
function setLegajoState(legajo, newState){
  const map = readStateMap();
  map[String(legajo || "")] = newState;
  writeStateMap(map);
}
function isToggleEnding(legajo, code){
  if (!TOGGLE_CODES.includes(code)) return false;
  const st = getLegajoState(legajo);
  return !!st.toggles[code];
}
function toggleStartOrEnd(legajo, code){
  const st = getLegajoState(legajo);
  const wasActive = !!st.toggles[code];
  if (wasActive) delete st.toggles[code];
  else st.toggles[code] = true;
  setLegajoState(legajo, st);
  return { started: !wasActive, ended: wasActive };
}

/* =========================================================
   BLOQUEO: si hay cualquier toggle activo (no-core), NO se puede seleccionar EP/TP/AP/TAP
   + deshabilitado visual
   ========================================================= */
function getAnyBlockingToggleActive(legajo){
  const st = getLegajoState(legajo);
  const keys = Object.keys(st.toggles || {});
  return keys[0] || null;
}

function updateCoreButtonsState(){
  const legajoStr = String(legajoInput.value || "");
  const blocking = getAnyBlockingToggleActive(legajoStr);

  document.querySelectorAll(".box").forEach(b=>{
    const code = b.querySelector(".box-title")?.innerText?.trim();
    if (!code) return;
    if (CORE_CODES.includes(code)) {
      if (blocking) b.classList.add("disabled");
      else b.classList.remove("disabled");
    }
  });
}

/* =========================================================
   SUGERENCIA (SOLO Picking/Armado)
   ========================================================= */
function ensurePendingSuggestionContainer(){
  let box = document.getElementById("pendingSuggestion");
  if (!box) {
    box = document.createElement("div");
    box.id = "pendingSuggestion";
    const row3El = document.getElementById("row3");
    if (row3El && row3El.parentNode) row3El.parentNode.insertBefore(box, row3El.nextSibling);
  }
  return box;
}

function renderPendingSuggestion(){
  const legajo = String(legajoInput.value || "");
  const box = ensurePendingSuggestionContainer();
  box.innerHTML = "";
  if(!legajo) return;

  // ‚úÖ SI HAY BLOQUEO (cualquier toggle activo), NO MOSTRAR sugerencias
  const blocking = getAnyBlockingToggleActive(legajo);
  if (blocking) return;

  const st = getLegajoState(legajo);

  // PICKING
  if (st.picking && st.picking.active && st.picking.value) {
    const btn = document.createElement("button");
    btn.className = "primary-btn";
    btn.innerText = `Ten√©s un Picking pendiente (${st.picking.value}) ‚Äî Presion√° para terminar`;
    btn.onclick = ()=>{
      selectOption("TP");
      textInput.value = st.picking.value || "";
    };
    box.appendChild(btn);
    return;
  }

  // ARMADO
  if (st.armado && st.armado.active && st.armado.value) {
    const btn = document.createElement("button");
    btn.className = "primary-btn";
    btn.innerText = `Ten√©s un Armado pendiente (${st.armado.value}) ‚Äî Presion√° para terminar`;
    btn.onclick = ()=>{
      selectOption("TAP");
      textInput.value = st.armado.value || "";
    };
    box.appendChild(btn);
    return;
  }
}

/* =========================================================
   ARMADO DE BOTONES
   ========================================================= */
Object.keys(filas).forEach(rowId => {
  filas[rowId].forEach(code => {
    const d = document.createElement("div");
    d.className = "box";
    d.innerHTML = `
      <div class="box-title">${code}</div>
      <div class="box-desc">${desc[code]}</div>
    `;
    d.onclick = () => selectOption(code);
    document.getElementById(rowId).appendChild(d);
  });
});

/* =========================================================
   NAVEGACI√ìN
   ========================================================= */
function goToOptions() {
  if (!legajoInput.value) return alert("Ingres√° el n√∫mero de legajo");
  legajoScreen.classList.add("hidden");
  optionsScreen.classList.remove("hidden");
  renderPendingSuggestion();
  updateCoreButtonsState();
}

function backToLegajo() {
  optionsScreen.classList.add("hidden");
  legajoScreen.classList.remove("hidden");
  renderLegajoHistory(legajoInput.value);
}

function selectOption(code) {
  const legajoStr = String(legajoInput.value || "");

  // bloqueo de core
  if (CORE_CODES.includes(code)) {
    const blocking = getAnyBlockingToggleActive(legajoStr);
    if (blocking) {
      alert(`Ten√©s una acci√≥n pendiente: ${blocking} ‚Äî ${desc[blocking]}\nTermin√°la antes de usar EP/TP/AP/TAP.`);
      updateCoreButtonsState();
      return;
    }
  }

  selected = code;
  selectedArea.classList.remove("hidden");

  selectedBox.innerText = code;
  selectedDesc.innerText = desc[code];

  // reset input
  inputArea.classList.add("hidden");
  textInput.value = "";
  textInput.placeholder = "";

  // ======= REGLA: toggles muestran input SOLO al TERMINAR (y algunos nunca)
  if (TOGGLE_CODES.includes(code)) {
  const ending = isToggleEnding(legajoStr, code);

  // Estos NUNCA piden input
  const NEVER_INPUT = ["AT","PB","Limp","PC","Perm","MG","CR","CT"];  // üëà CR agregado y CT

  if (ending && !NEVER_INPUT.includes(code)) {
    inputArea.classList.remove("hidden");

    if (code === "CC") {
      inputLabel.innerText = "Ingresar Nro Picking";
      textInput.placeholder = "Ejemplo: A12";
    } else {
      inputLabel.innerText = "Indicar Cantidad";
      textInput.placeholder = "Ejemplo: 100";
    }
  }
}

  // ======= Picking / Armado siguen igual (siempre piden nro)
  else if (["EP","TP","AP","TAP"].includes(code)) {
    inputArea.classList.remove("hidden");
    inputLabel.innerText = "Ingresar Nro Picking";
    textInput.placeholder = "Ejemplo: A12B";
  }

  // Avisos
  if (["AT","PB","Limp","PC","CT"].includes(code)) {
    aviso.classList.remove("hidden");
    aviso.innerText = "Acordate de poner lo mismo al terminar";
  } else {
    if (["Perm"].includes(code)) {
      aviso.classList.remove("hidden");
      aviso.innerText = "Acordate de poner lo mismo si regresas en el mismo dia";
    } else {
      aviso.classList.add("hidden");
    }
  }

  updateCoreButtonsState();
}

function resetSelection() {
  selected = null;
  selectedArea.classList.add("hidden");
}

/* =========================================================
   ENV√çO
   ========================================================= */
function send() {
  const legajoStr = String(legajoInput.value || "");
  const opcion = selected;
  const descripcion = desc[selected] || "";
  const texto = (textInput.value || "").toUpperCase();

  /* ---- historial ---- */
  if (legajoStr && opcion) {
    pushHistoryForLegajo(legajoStr, {
      ts: Date.now(),
      opcion,
      descripcion,
      texto
    });
  }

  /* ---- estado / pendientes ---- */
  if (opcion === "EP") {
    const st = getLegajoState(legajoStr);
    st.picking = { active:true, value:texto };
    setLegajoState(legajoStr, st);
  } else if (opcion === "TP") {
    const st = getLegajoState(legajoStr);
    st.picking = { active:false, value:"" };
    setLegajoState(legajoStr, st);
  } else if (opcion === "AP") {
    const st = getLegajoState(legajoStr);
    st.armado = { active:true, value:texto };
    setLegajoState(legajoStr, st);
  } else if (opcion === "TAP") {
    const st = getLegajoState(legajoStr);
    st.armado = { active:false, value:"" };
    setLegajoState(legajoStr, st);
  } else if (TOGGLE_CODES.includes(opcion)) {
    // 1ra vez inicia / 2da termina
    toggleStartOrEnd(legajoStr, opcion);
  }

  fetch(GOOGLE_SCRIPT_URL,{
    method:"POST",
    body:JSON.stringify({
      legajo: legajoInput.value,
      opcion: selected,
      descripcion: desc[selected],
      texto: texto
    })
  }).catch(()=>{});

  alert("Reporte enviado correctamente");

  resetSelection();
  optionsScreen.classList.add("hidden");
  legajoScreen.classList.remove("hidden");

  renderLegajoHistory(legajoInput.value);

  legajoInput.value = "";
  renderLegajoHistory("");

  updateCoreButtonsState();
  renderPendingSuggestion();
}

/* init */
renderLegajoHistory("");
</script>

</body>
</html>
