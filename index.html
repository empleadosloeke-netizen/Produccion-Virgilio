<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reporte Empleados</title>

<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 12px; }
.hidden { display: none; }

button {
  width: 100%;
  padding: 16px;
  font-size: 22px;
  margin-top: 14px;
  border-radius: 6px;
}

.primary-btn { background: #1e6bd6; color: white; border: none; }

/* ---------- PANTALLA LEGAJO ---------- */
#legajoScreen h1 { font-size: 36px; text-align: center; }
#legajoInput { width: 100%; font-size: 34px; padding: 12px; text-align: center; border: 6px solid; }

/* üëá espacio donde se ver√° el historial (ACHICADO) */
#legajoHistorySpace{
  margin-top: 12px;
  min-height: 25vh;  /* antes 45vh */
  border-radius: 10px;
  padding: 12px;
  box-sizing: border-box;
}

/* Estilo del historial */
.history-title{
  font-size: 18px;
  font-weight: bold;
  text-align: center;
  margin-bottom: 10px;
}
.history-item{
  border: 2px solid #333;
  border-radius: 10px;
  padding: 10px 12px;
  margin-bottom: 10px;
}
.history-item .line1{
  font-size: 18px;
  font-weight: bold;
}
.history-item .line2{
  margin-top: 4px;
  font-size: 14px;
  color: #333;
  word-break: break-word;
}
.history-empty{
  font-size: 16px;
  text-align: center;
  color: #666;
  margin-top: 18px;
}

.row { display: grid; gap: 8px; margin-top: 13px; }
.row-6 { grid-template-columns: repeat(6, 1fr); }
.row-5 { grid-template-columns: repeat(5, 1fr); }
.row-4 { grid-template-columns: repeat(4, 1fr); }

.box { border: 2px solid #333; padding: 8px 4px; text-align: center; cursor: pointer; }
.box-title { font-size: 18px; font-weight: bold; }
.box-desc { font-size: 10px; margin-top: 3px; }

.top-bar { display: flex; align-items: center; margin-bottom: 6px; }
.back-top { font-size: 28px; cursor: pointer; }

.selected-container { display: flex; align-items: center; justify-content: center; margin-top: 16px; }
.back-arrow { font-size: 32px; cursor: pointer; margin-right: 10px; }
.selected-box { border: 2px solid #333; padding: 10px 22px; font-size: 28px; font-weight: bold; color: #1e6bd6; }
.selected-desc { margin-left: 12px; font-size: 18px; font-weight: bold; }

.label { margin-top: 14px; font-size: 22px; text-align: center; white-space: pre-line; }
.text-input { width: 100%; height: 68px; font-size: 64px ; border:6px solid ; text-align: center; margin-top: 8px; text-transform: uppercase; }
.text-input::placeholder { font-size: 26px; color: #aaa; }

.error { color: red; margin-top: 10px; font-size: 18px; text-align: center; }
.small { font-size: 14px; color: #666; text-align:center; margin-top:6px; }
.aviso-label{
 margin-top:10px;
 padding:8px 12px;
 background:#fff3cd;
 border:1px solid #ffeeba;
 border-radius:6px;
 font-size:30px;
 text-align:center;
}
</style>
</head>

<body>

<!-- ================= LEGAJO ================= -->
<div id="legajoScreen">
  <h1>Ingres√° tu n√∫mero de legajo</h1>
  <input id="legajoInput" type="number" inputmode="numeric">

  <!-- üëá espacio para historial -->
  <div id="legajoHistorySpace">
    <div class="history-title">√öltimos 2 reportes de este legajo</div>
    <div id="legajoHistoryContent" class="history-empty">Ingres√° tu legajo para ver el historial</div>
  </div>

  <button class="primary-btn" onclick="goToOptions()">Continuar</button>
  <div class="small" id="status"></div>
  <div id="legajoError" class="error"></div>
</div>

<!-- ================= OPCIONES ================= -->
<div id="optionsScreen" class="hidden">

  <div class="top-bar">
    <div class="back-top" onclick="backToLegajo()">‚Üê</div>
  </div>

  <div class="row row-6" id="row1"></div>
  <div class="row row-4" id="row2"></div>
  <div class="row row-5" id="row3"></div>

  <div id="selectedArea" class="hidden">

    <div class="selected-container">
      <div class="back-arrow" onclick="resetSelection()">‚Üê</div>
      <div id="selectedBox" class="selected-box"></div>
      <div id="selectedDesc" class="selected-desc"></div>
    </div>
    <div id="aviso" class="hidden aviso-label"></div>
    <div id="inputArea" class="hidden">
      <div id="inputLabel" class="label"></div>
      <input id="textInput" class="text-input">
    </div>

    <button class="primary-btn" onclick="send()">Enviar</button>
    <div id="error" class="error"></div>

  </div>
</div>

<script>
const GOOGLE_SCRIPT_URL =
"https://script.google.com/macros/s/AKfycbwtBRC-bEeVkFNa8MQnJwJr_L4DalBVoS6N8H9C1Z0vh2CLI29Sep7ZZIIVKz6eOGzj/exec";

const filas = {
  row1: ["EP","TP","AP","TAP","CR","CC"],
  row2: ["RT","MG","RI","EI"],
  row3: ["AT","PB","Limp","Perm","PC"]
};

const desc = {
  EP:"Empec√© Picking", TP:"Fin Picking", AP:"Empec√© Armado Pedido",
  TAP:"Termin√© Armado Pedido", CR:"Control Remitos", CC:"Inicio/Fin Carga Cami√≥n",
  RT:"Recepci√≥n Mercader√≠a", MG:"Guardado a G√≥ndola",
  RI:"Recepci√≥n Insumos", EI:"Entrega Insumos",
  AT:"Atend√≠ Timbre", PB:"Par√© Ba√±o", Limp:"Limpieza",
  Perm:"Permiso de Salida", PC:"Par√© Comida"
};

let selected = null;

/* =========================================================
   COOKIES: guardar historial por legajo (√∫ltimos 2)
   ========================================================= */
const HISTORY_COOKIE = "legajo_history_v1";
const HISTORY_DAYS = 365;

function setCookie(name, value, days) {
  const d = new Date();
  d.setTime(d.getTime() + (days*24*60*60*1000));
  const expires = "expires=" + d.toUTCString();
  document.cookie = `${name}=${encodeURIComponent(value)}; ${expires}; path=/; SameSite=Lax`;
}

function getCookie(name) {
  const cookies = document.cookie ? document.cookie.split("; ") : [];
  for (const c of cookies) {
    const [k, ...rest] = c.split("=");
    if (k === name) return decodeURIComponent(rest.join("="));
  }
  return "";
}

function readHistoryMap() {
  try {
    const raw = getCookie(HISTORY_COOKIE);
    if (!raw) return {};
    const obj = JSON.parse(raw);
    if (obj && typeof obj === "object") return obj;
    return {};
  } catch {
    return {};
  }
}

function writeHistoryMap(map) {
  setCookie(HISTORY_COOKIE, JSON.stringify(map), HISTORY_DAYS);
}

function formatDateTime(ts) {
  try {
    const d = new Date(ts);
    return d.toLocaleString("es-AR");
  } catch {
    return "";
  }
}

function pushHistoryForLegajo(legajo, item) {
  const map = readHistoryMap();
  if (!map[legajo]) map[legajo] = [];
  map[legajo].unshift(item);
  map[legajo] = map[legajo].slice(0,2);
  writeHistoryMap(map);
}

function getHistoryForLegajo(legajo) {
  const map = readHistoryMap();
  const arr = map[legajo];
  return Array.isArray(arr) ? arr : [];
}

function renderLegajoHistory(legajo) {
  const container = document.getElementById("legajoHistoryContent");
  if (!legajo) {
    container.className = "history-empty";
    container.innerText = "Ingres√° tu legajo para ver el historial";
    return;
  }

  const hist = getHistoryForLegajo(String(legajo));
  if (!hist.length) {
    container.className = "history-empty";
    container.innerText = "No hay reportes guardados para este legajo en este dispositivo.";
    return;
  }

  container.className = "";
  container.innerHTML = hist.map(h => `
    <div class="history-item">
      <div class="line1">${h.opcion} ‚Äî ${h.descripcion}</div>
      <div class="line2">
        ${h.texto ? `Dato: <b>${h.texto}</b><br>` : ""}
        ${h.ts ? `Fecha: ${formatDateTime(h.ts)}` : ""}
      </div>
    </div>
  `).join("");
}

let legajoTimer = null;
legajoInput.addEventListener("input", () => {
  clearTimeout(legajoTimer);
  legajoTimer = setTimeout(() => {
    renderLegajoHistory(legajoInput.value);
  }, 150);
});

/* ========================================================= */

Object.keys(filas).forEach(rowId => {
  filas[rowId].forEach(code => {
    const d = document.createElement("div");
    d.className = "box";
    d.innerHTML = `
      <div class="box-title">${code}</div>
      <div class="box-desc">${desc[code]}</div>
    `;
    d.onclick = () => selectOption(code);
    document.getElementById(rowId).appendChild(d);
  });
});

function goToOptions() {
  if (!legajoInput.value) return alert("Ingres√° el n√∫mero de legajo");
  legajoScreen.classList.add("hidden");
  optionsScreen.classList.remove("hidden");
}

function backToLegajo() {
  optionsScreen.classList.add("hidden");
  legajoScreen.classList.remove("hidden");
  renderLegajoHistory(legajoInput.value);
}

function selectOption(code) {
  selected = code;
  selectedArea.classList.remove("hidden");

  selectedBox.innerText = code;
  selectedDesc.innerText = desc[code];

  inputArea.classList.add("hidden");
  textInput.value = "";

  if (["EP","TP","AP","TAP","CR"].includes(code)) {
    inputArea.classList.remove("hidden");
    inputLabel.innerText = "Ingresar Nro Picking";
    textInput.placeholder = "Ejemplo: A12B";
  }
  if(["CC"].includes(code)){
    inputArea.classList.remove("hidden");
    inputLabel.innerText = "Solo Si TERMINO \n Ingresar Nro Picking";
    textInput.placeholder = "Ejemplo: A12";
  }
  if (["RT","MG"].includes(code)) {
    inputArea.classList.remove("hidden");
    inputLabel.innerText = "Indicar Cantidad Cajas";
    textInput.placeholder = "Ejemplo: 100";
  }
  if (["AT","PB","Limp","PC"].includes(code)) {
    aviso.classList.remove("hidden");
    aviso.innerText = "Acordate de poner lo mismo al terminar";
  } else {
    if (["Perm"].includes(code)) {
      aviso.classList.remove("hidden");
      aviso.innerText = "Acordate de poner lo mismo si regresas en el mismo dia";
    } else {
      aviso.classList.add("hidden");
    }
  }
}

function resetSelection() {
  selected = null;
  selectedArea.classList.add("hidden");
}

function send() {
  const legajo = String(legajoInput.value || "");
  const opcion = selected;
  const descripcion = desc[selected] || "";
  const texto = (textInput.value || "").toUpperCase();

  if (legajo && opcion) {
    pushHistoryForLegajo(legajo, {
      ts: Date.now(),
      opcion,
      descripcion,
      texto
    });
  }

  fetch(GOOGLE_SCRIPT_URL,{
    method:"POST",
    body:JSON.stringify({
      legajo: legajoInput.value,
      opcion: selected,
      descripcion: desc[selected],
      texto: texto
    })
  }).catch(()=>{});

  alert("Reporte enviado correctamente");

  resetSelection();
  optionsScreen.classList.add("hidden");
  legajoScreen.classList.remove("hidden");

  renderLegajoHistory(legajoInput.value);

  legajoInput.value = "";
  renderLegajoHistory("");
}

renderLegajoHistory("");
</script>

</body>
</html>